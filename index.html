<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
  <title>OPT Calculator</title>
  <meta name="author" content="Daniel Castano">
  <link rel="stylesheet" href="./css/pikaday.css">
  <link rel="stylesheet" href="./css/site.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

  <script>
  //Max Start/End dates tupla to add
  var max_fields  = 3;
  //Each Start/End dates tupla has an id
  var id = 1;
  //Once the HTML is loaded
  $(document).ready(function() {

    //div where calendars will be added
    var wrapper         = $(".addRanges");
    //add range button
    var add_button      = $("#buttonAddRanges");
    //var reset button
    var reset_button      = $("#buttonReset");
    $(reset_button).click(function(e){
      e.preventDefault();
      reset();
//      alert('Severa Flor')
    });
    //If user press button ADD
    $(add_button).click(function(e){
      e.preventDefault();
      //If there are less than 3 Start/End tuplas
      if(id < max_fields){
        //Increase Id
        id++;
        //Add two pickaday calendars to choose start and final date
        $(wrapper).append('<div id="addDelete'+id+'"><br><div style="display: inline-block"><label for="start">Start:</label><br><input class="input is-rounded is-small" type="text" id="start'+id+'" name = "start'+id+'"></div>&nbsp;<div style="display: inline-block"><label for="end">End:</label><br><input class="input is-rounded is-small" type="text" id="end'+id+'" name = "end'+id+'"></div> <input type="checkbox" name="partime'+id+'" value="partime'+id+'" id="partime'+id+'" onchange="daysCalculation()"> Was it a part-time?<a href="#"  class="delete is-large" id="delete'+id+'" name="delete'+id+'" style="vertical-align:middle;">Delete</a></div>');
        //Include calendar behaviour
        createRangeCalendars();
        //Removes the last remove button
        if(id>2){
          $('#delete'+(id-1)).remove();
        }
      }
      else
      {
        //Pop up if user reach max
        alert('You Reached the limit')
      }
    });
    //Click in DELETE buttons
      $(wrapper).on("click",".delete", function(e){
        e.preventDefault();
        $(this).parent('div').remove();
        daysCalculation();
        id--;
        var position = this.name.slice(-1);
        //Add delete button to new Start/End tupla
        $('#addDelete'+(position-1)).append('<a href="#" class="delete is-large" id="delete'+id+'" name="delete'+id+'" style="vertical-align:middle;">Delete</a>');
      })


    });
    function reset(){
      for(i = 0; i < calendars.length; i++){
        calendars[i].setDate(null)
      }
      for(i = 1; i <= max_fields; i++){
        var check = document.getElementById('partime'+i);
        if(check != null){
          check.checked = false;
      }
    }
    daysCalculation();
  }
    //Calculate the days left to do OPT
    function daysCalculation(){
      var ranges = [];
      var milliseconds = 0;
      for(i = 1; i <= max_fields; i++){
        var start = (document.getElementById('start'+i));
        var end = (document.getElementById('end'+i));
        var check = document.getElementById('partime'+i);
        if(start == null || end == null || check == null){
          ranges[i-1] = 0;
        }
        else{
          if(start.value == "" || end.value == ""){
            ranges[i-1] = 0;
          }
          else{
            var startDate = new Date(start.value);
            var endDate = new Date(end.value);
            ranges[i-1] = check.checked ? Math.abs(endDate - startDate  + 86400000)*.5 : Math.abs(endDate - startDate + 86400000);
          }
        }
        milliseconds = Math.abs(milliseconds + ranges[i-1]);
      }
      var days = 365 - (milliseconds / (1000*60*60*24));
      if(days < 0){
        days = 0 ;
      }
      days = precisionRound(days,1);
      //console.log("Days will be: " + days);
      document.getElementById('days').innerHTML = "You have: "  +days+" days left to do another OPT";
    }
    // Method to round the date in a nuumber with range 0.5
    function precisionRound(number, precision) {
      var factor = Math.pow(10, precision);
      return Math.round(number * factor) / factor;
    }
    function createRangeCalendars(){
      //RANGE functionality
      var startDate,
      endDate,
      updateStartDate = function() {
        startPicker.setStartRange(startDate);
        endPicker.setStartRange(startDate);
        endPicker.setMinDate(startDate);
      },
      updateEndDate = function() {
        startPicker.setEndRange(endDate);
        startPicker.setMaxDate(endDate);
        endPicker.setEndRange(endDate);
      },
      startPicker = new Pikaday({
        field: document.getElementById('start'+id+''),
        minDate: new Date(2000, 01, 01),
        maxDate: new Date(2020, 12, 31),
        onSelect: function() {
          startDate = this.getDate();
          daysCalculation();
          updateStartDate();

        }
      }),
      endPicker = new Pikaday({
        field: document.getElementById('end'+id+''),
        minDate: new Date(),
        maxDate: new Date(2020, 12, 31),
        onSelect: function() {
          endDate = this.getDate();
          daysCalculation();
          updateEndDate();

        }
      }),
      _startDate= startPicker.getDate(),
      _endDate = endPicker.getDate();

      if (_startDate) {
        startDate = _startDate;
        updateStartDate();
        daysCalculation();
      }
      if (_endDate) {
        endDate = _endDate;
        updateEndDate();
        daysCalculation();
      }
      calendars.push(startPicker);
      calendars.push(endPicker);

    }
  </script>

</head>
<body>
  <section class="hero is-info is-large is-bold">
    <div class="hero-body">
      <div class="container">
        <h1 class="title">Welcome to the OPT Calculator</h1>

        <p class="large">If you have already done OPT at your current academic level, use this date calculator to find out how much time you have remaining for your OPT to calculate your end date. If you have done more than 11.5 months of full-time CPT then OPT is no longer available to you.</p>

        <form method = 'POST' action = '/process' >

          <h2>Past OPT(s)</h2>

          <div style="display: inline-block">
            <label for="start">Start:</label>
            <br>
            <input class="input is-rounded is-small" type="text" id="start1" name = "start1">
          </div>
          <div style="display: inline-block">
            <label for="end">End:</label>
            <br>
            <input class="input is-rounded is-small" type="text" id="end1" name = "end1">
          </div>
          <input type="checkbox" name="partime1" value="partime1" id="partime1" onchange = "daysCalculation()" > Was it a part-time?
          <div class="addRanges" style="display: inline">
          </div>
          <br>
          <button class="button" id="buttonAddRanges">Add New OPT &nbsp; <span style="font-size:16px; font-weight:bold;">+ </span></button>
          <button class="button" id="buttonReset">Reset</button>

          <div style="display: inline-block">

            <!--  <input class = "button is-success" id="calculate" type="submit" name="submitbutton" value="CALCULATE" />
            <button type="button" id="calculate">Calculate Submission Range</button>
          -->    </div>
          <br>
          <br>
          <p id = "days" class="large">You have: 365 days left to do another OPT</p>
        </form>

        <script src="./pikaday.js"></script>
        <script>
        //store all calendars
        var calendars = [];
        var startDate1,
        endDate1,
        updateStartDate1 = function() {
          startPicker1.setStartRange(startDate1);
          endPicker1.setStartRange(startDate1);
          endPicker1.setMinDate(startDate1);
        },
        updateEndDate1 = function() {
          startPicker1.setEndRange(endDate1);
          startPicker1.setMaxDate(endDate1);
          endPicker1.setEndRange(endDate1);
        },
        startPicker1 = new Pikaday({
          field: document.getElementById('start1'),
          minDate: new Date(2000, 01, 01),
          maxDate: new Date(2020, 12, 31),
          onSelect: function() {
            startDate1 = this.getDate();
            updateStartDate1();daysCalculation();
          }
        }),
        endPicker1 = new Pikaday({
          field: document.getElementById('end1'),
          minDate: new Date(),
          maxDate: new Date(2020, 12, 31),
          onSelect: function() {
            endDate1 = this.getDate();
            updateEndDate1();daysCalculation();
          }
        }),
        _startDate1 = startPicker1.getDate(),
        _endDate1 = endPicker1.getDate();

        if (_startDate1) {
          startDate1 = _startDate1;
          updateStartDate1();
        }
        if (_endDate1) {
          endDate1 = _endDate1;
          updateEndDate1();
        }
        calendars.push(startPicker1);
        calendars.push(endPicker1);
      </script>
    </div>
  </div>
</section>
</body>
</html>
